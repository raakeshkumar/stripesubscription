<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subscribe</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://js.stripe.com/v3/"></script>
  </head>
  <body>
    <div class="container py-5">
      <h2 class="text-center mb-4">User Registration & Payment Form</h2>
      <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
          <!-- User Registration Form -->
          <form id="registrationForm">
            <div class="mb-3">
              <label for="name" class="form-label">Name</label>
              <input type="text" class="form-control" id="name" required />
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" required />
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
          </form>

          <div id="payment-form" style="display: none" class="mt-4">
            <div id="payment-element"></div>
            <button id="submit" class="btn btn-success mt-3">Subscribe</button>
            <div id="error-message" class="text-danger mt-2"></div>
          </div>

          <div id="result" class="mt-4"></div>
        </div>
      </div>
    </div>

    <script>
      const stripe = Stripe(
        "YOUR_SECRET_KEY"
      );

      // Function to get query parameter from URL
      function getQueryParameter(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      document
        .getElementById("registrationForm")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const name = document.getElementById("name").value;
          const email = document.getElementById("email").value;
          const productId = getQueryParameter("productID"); // Fetch product ID from the URL

          if (!productId) {
            document.getElementById("result").innerHTML = `
            <div class="alert alert-danger">Product ID is missing in the URL.</div>
          `;
            return;
          }

          // Step 1: Send data to user registration API
          try {
            const userResponse = await fetch(
              "http://localhost:3000/api/users",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  name: name,
                  email: email,
                }),
              }
            );

            const userData = await userResponse.json();

            // Check if user API was successful
            if (userResponse.ok && userData.id) {
              const customerId = userData.id; // Extract customer ID from response

              // Step 2: Send data to subscription API
              const subscriptionResponse = await fetch(
                "http://localhost:3000/api/subscriptions",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    customer: customerId,
                    priceId: productId, // Use productId from URL
                  }),
                }
              );

              const subscriptionData = await subscriptionResponse.json();

              // Step 3: Handle subscription API response
              if (subscriptionResponse.ok && subscriptionData.clientSecret) {
                // Success - show payment form and initiate Stripe Elements
                const clientSecret = subscriptionData.clientSecret;

                // Show the payment form
                document.getElementById("payment-form").style.display = "block";

                const elements = stripe.elements({ clientSecret });
                const paymentElement = elements.create("payment");
                paymentElement.mount("#payment-element");

                document
                  .getElementById("submit")
                  .addEventListener("click", async function (event) {
                    event.preventDefault();

                    const { error } = await stripe.confirmPayment({
                      elements,
                      confirmParams: {
                        return_url:
                          "https://5bfb-122-161-64-198.ngrok-free.app/subscription/frontend/registration.html",
                      },
                    });

                    if (error) {
                      const messageContainer =
                        document.querySelector("#error-message");
                      messageContainer.textContent = error.message;
                    }
                  });
              } else {
                document.getElementById("result").innerHTML = `
                <div class="alert alert-danger">Subscription creation failed.</div>
              `;
              }
            } else {
              document.getElementById("result").innerHTML = `
              <div class="alert alert-danger">User registration failed.</div>
            `;
            }
          } catch (error) {
            console.error("Error:", error);
            document.getElementById("result").innerHTML = `
            <div class="alert alert-danger">An error occurred. Please try again later.</div>
          `;
          }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
